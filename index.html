<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crionic • NestEx Dashboard</title>
<style>
:root{--bg:#050608;--neon:#00ffd5;--accent:#7be495;--muted:#94a3b8;--text:#cfeee8}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:linear-gradient(180deg,#030406,#07080b);font-family:Inter,system-ui,Arial;color:var(--text)}
.container{max-width:1100px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.title{font-weight:800;color:var(--neon);font-size:20px}
.sub{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
.card{background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.h3{font-size:13px;color:var(--accent);margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.btn{padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#7b61ff,#00ffd5);border:none;color:#041018;font-weight:700;cursor:pointer}
.log{font-family:monospace;color:var(--muted);font-size:12px;max-height:320px;overflow:auto;padding:8px;background:rgba(0,0,0,0.18);border-radius:6px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Crionic Dashboard • NestEx</div>
        <div class="sub">Privátne info z NestEx (balances, orders) — server-side proxy, kľúče na serveri</div>
      </div>
      <div>
        <button id="btnRefresh" class="btn">Manual refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="h3">Balances</div>
        <div id="balancesArea" class="small">Načítanie...</div>

        <hr style="margin:10px 0;border:none;border-top:1px dashed rgba(255,255,255,0.03)">

        <div class="h3">Orders (open)</div>
        <div id="ordersArea" class="small">Načítanie...</div>
      </div>

      <div class="card">
        <div class="h3">Status & Logs</div>
        <div id="statusBox" class="small">Stav: pripravený</div>
        <div style="height:10px"></div>
        <div class="h3">Log</div>
        <div id="logArea" class="log">—</div>
      </div>
    </div>

    <div class="footer">Dbaj na bezpečnosť: API KEY/SECRET NEVKLADAJ do frontend kódu ani do repozitára.</div>
  </div>

<script>
/*
  index.html - calls server endpoints:
   POST /api/nestex/checktoken
   POST /api/nestex/balances
   POST /api/nestex/orders

  Server enforces 5s minimum gap. Frontend polls every 6s to be safe.
*/

const cfg = { pollInterval: 6000, apiBase: '/api/nestex' };

function log(msg){ const el=document.getElementById('logArea'); el.textContent = new Date().toISOString() + ' ' + msg + '\n' + el.textContent; }
function setStatus(s){ document.getElementById('statusBox').textContent = 'Stav: ' + s; }

async function postJson(path, body = {}) {
  const url = cfg.apiBase + path;
  const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const ct = res.headers.get('content-type')||'';
  let data;
  try { data = ct.includes('application/json') ? await res.json() : await res.text(); }
  catch(e){ data = await res.text(); }
  return { status: res.status, data };
}

async function updateAll() {
  setStatus('updating...');
  try{
    // check token first
    const chk = await postJson('/checktoken');
    if (chk.status === 200) {
      setStatus('token ok');
      log('checktoken ok');
    } else {
      setStatus('token invalid or error');
      log('checktoken status ' + chk.status + ' ' + JSON.stringify(chk.data));
    }

    // balances
    const bal = await postJson('/balances');
    if (bal.status === 200) {
      renderBalances(bal.data);
      log('balances fetched');
    } else {
      document.getElementById('balancesArea').textContent = 'Error: ' + bal.status;
      log('balances error: ' + JSON.stringify(bal.data));
    }

    // orders
    const ord = await postJson('/orders');
    if (ord.status === 200) {
      renderOrders(ord.data);
      log('orders fetched');
    } else {
      document.getElementById('ordersArea').textContent = 'Error: ' + ord.status;
      log('orders error: ' + JSON.stringify(ord.data));
    }

  } catch (e) {
    log('updateAll error: ' + (e.message || e));
    setStatus('error');
  } finally {
    setTimeout(()=>setStatus('idle'), 4000);
  }
}

function renderBalances(data){
  // expected data: { balances: {...}, locked: {...}, success: "ok" }
  if(!data || !data.balances){ document.getElementById('balancesArea').textContent = JSON.stringify(data); return; }
  const b = data.balances;
  const l = data.locked || {};
  const lines = Object.keys(b).map(k => `${k}: ${b[k]} (locked: ${l[k]||0})`);
  document.getElementById('balancesArea').textContent = lines.join('\n');
}

function renderOrders(data){
  // expected data: { orders: [ ... ], success: "ok" }
  if(!data || !Array.isArray(data.orders)){ document.getElementById('ordersArea').textContent = JSON.stringify(data); return; }
  const rows = data.orders.map(o => `#${o.order_id} ${o.cur} ${o.order_type} ${o.quantity} @ ${o.price} (${o.status})`);
  document.getElementById('ordersArea').textContent = rows.length ? rows.join('\n') : 'No open orders';
}

// manual refresh button
document.getElementById('btnRefresh').addEventListener('click', ()=>{ updateAll(); });

updateAll();
setInterval(updateAll, cfg.pollInterval);
</script>
</body>
</html>
